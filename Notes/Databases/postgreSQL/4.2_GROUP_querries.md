# Агрегирование и группировка

Агрегирование позволяет в одной строке результат размещать значение, вычисленные по нескольким строкам и таблицам.

Виды ф-ий: count, avg, sum. min, max.

`GROUP BY элемент_группирования [, ...]` - собирает в одну строку все выбранные строки, выдающие одинаковые значения для выражений группировки

1. В таблице  определяются строки, в которых в выбранном столбце одинаковые значения. Получаем различные группы.

2. Вместо каждой группы в результирующий запрос включается  одна запись. Запись как минимум включает значение столбца, по которому осуществляется группировка

3. Дальше можно выполнить вычисления над элементами КАЖДОЙ группы в отдельности, например, посчитать общее количество экземпляров книг каждого автора. Для этого используется групповая функция ***SUM()***, а в скобках указывается столбец, по которому нужно выполнить суммирование

    Также можно посчитать, сколько записей относится к группе. Для этого используется функция ***COUNT()***, в скобках можно указать ЛЮБОЙ столбец из группы, если группа не содержит пустых значений (ниже приведен пример, в котором показано, как работает COUNT(), если в группе есть пустые значения);

В качестве аргумента групповых функций  SQL может использоваться не только столбец, но и любое допустимое в SQL арифметическое выражение.

**Пример:** вывести суммарную стоимость книг каждого автора.
```
SELECT author, SUM(price * amount) AS Стоимость
FROM book
GROUP BY author;

+------------------+-----------+---------+-------------------+
| author           | Стоимость | НДС     | Стоимость_без_НДС |
+------------------+-----------+---------+-------------------+
| Булгаков М.А.    | 4715.47   | 719.31  | 3996.16           |
| Достоевский Ф.М. | 11802.03  | 1800.31 | 10001.72          |
| Есенин С.А.      | 9750.00   | 1487.29 | 8262.71           |
+------------------+-----------+---------+-------------------+
```
<br>

# Вычисления по таблице целиком

Групповые функции позволяют вычислять итоговые значения по всей таблице. Например, можно посчитать общее количество книг на складе, вычислить суммарную стоимость и пр. Для этого после ключевого слова SELECT указывается групповая функция для выражения или имени столбца, а ключевые слова GROUP BY опускаются.

**Пример:** Вывести  цену самой дешевой книги, цену самой дорогой и среднюю цену уникальных книг на складе. Названия столбцов Минимальная_цена, Максимальная_цена, Средняя_цена соответственно. Среднюю цену округлить до двух знаков после запятой.

```
SELECT
    MIN(price) AS 'Минимальная_цена',
    MAX(price) AS 'Максимальная_цена',
    ROUND(AVG(price),2) AS 'Средняя_цена'
FROM book;

+------------------+-------------------+--------------+
| Минимальная_цена | Максимальная_цена | Средняя_цена |
+------------------+-------------------+--------------+
| 460.00           | 799.01            | 600.17       |
+------------------+-------------------+--------------+
```
<br>

# HAVING

В запросы с групповыми функциями можно включать условие отбора строк, которое в обычных запросах записывается после **WHERE**. В запросах с групповыми функциями вместо **WHERE** используется ключевое слово **HAVING** , которое размещается после оператора **GROUP BY**.

**Пример:** Найти минимальную и максимальную цену книг всех авторов, общая стоимость книг которых больше 5000.

```
SELECT author,
    MIN(price) AS Минимальная_цена, 
    MAX(price) AS Максимальная_цена
FROM book
GROUP BY author
HAVING SUM(price * amount) > 5000;

+------------------+------------------+-------------------+
| author           | Минимальная_цена | Максимальная_цена |
+------------------+------------------+-------------------+
| Достоевский Ф.М. | 460.00           | 799.01            |
| Есенин С.А.      | 650.00           | 650.00            |
+------------------+------------------+-------------------+
```

<br>

# Группировка по нескольким столбцам

В разделе GROUP BY можно указывать несколько столбцов, разделяя их запятыми. Тогда к одной группе будут относиться записи, у которых значения столбцов, входящих в группу, равны. Рассмотрим группировку по нескольким столбцам на примере следующего запроса:
```
SELECT name, number_plate, violation, count(*)
FROM fine
GROUP BY name, number_plate, violation;
```
1. Сначала записи таблицы  **fine** разделяются на группы. В каждую группу включаются строки, у которых равны значения в столбцах **name**, **number_plate** и **violation**  соответственно. Получается 6 групп. 

2. Затем вычисляется функция count(*), которая определяет количество записей в каждой группе. Получается, что к первым двум группам относятся по две записи, ко всем остальным - по одной.

**Важно!** В разделе GROUP BY нужно перечислять все НЕАГРЕГИРОВАННЫЕ столбцы (к которым не применяются групповые функции) из SELECT.